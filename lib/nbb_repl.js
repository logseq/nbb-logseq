import { $APP, shadow$provide, $jscomp } from "./nbb_core.js";
import "./nbb_api.js";
const shadow_esm_import = function(x) { return import(x) };
import*as esm_import$node_net from"node:net";import*as esm_import$node_process from"node:process";import*as esm_import$node_readline from"node:readline";import*as esm_import$node_vm from"node:vm";
var IT=function(a){var b=function(){var e=$APP.Gr.h(a,"(");return $APP.k(e)?new $APP.G(null,2,5,$APP.H,[$APP.Wi.j(a,0,e+1),$APP.Wi.h(a,e+1)],null):new $APP.G(null,2,5,$APP.H,[null,a],null)}(),c=$APP.y.j(b,0,null),d=$APP.y.j(b,1,null);b=$APP.B.h(function(){try{return $APP.AMa(new $APP.h(null,2,[$APP.P,$APP.l.g($APP.n(HT)),$APP.$G,d],null))}catch(f){var e=f;console.warn($APP.l.g($APP.LBa),$APP.hk(e));return null}}(),"completions");return $APP.fj.h(function(e){return[$APP.l.g(c),$APP.l.g(e)].join("")},
$APP.Ug(function(e){return $APP.Ea(e,d)},$APP.fj.h(function(e){return $APP.B.h(e,"candidate")},b)))},YXa=function(a){return[$APP.zs.g(IT(a)),a]},ZXa=function(a,b){$APP.vg(JT,!1);a.setPrompt([$APP.l.g($APP.n(HT)),"\x3d\x3e "].join(""));a.prompt();return $APP.il($APP.n(KT))?null:LT.h?LT.h(b,a):LT.call(null,b,a)},$Xa=function(a){var b=$APP.vl(a);a=$APP.wl(a);var c=$APP.hl($APP.n(KT));b=$APP.Eg.h(b-1,c);c=$APP.r(b);b=$APP.v(c);c=$APP.w(c);a=$APP.k(b)?$APP.Wi.h(b,a):null;$APP.vg(KT,$APP.on.h("\n",$APP.zf(a,
c)))},aYa=function(a,b){b={f:b};esm_import$node_vm.createContext(b);try{return $APP.k($APP.k(MT)?$APP.Bb(a):MT)&&esm_import$node_process.stdin.setRawMode(!1),esm_import$node_vm.runInContext("f()",b,{displayErrors:!0,breakOnSigint:!0,microtaskMode:"afterEvaluate"}).then(function(c){var d={f:$APP.k(a)?function(){return c}:function(){var e=$APP.v(c);$APP.zu.l($APP.z([e]));return c}};esm_import$node_vm.createContext(d);return esm_import$node_vm.runInContext("f()",d,{displayErrors:!0,breakOnSigint:!0,
microtaskMode:"afterEvaluate"})}).finally(function(){return $APP.k($APP.k(MT)?$APP.Bb(a):MT)?esm_import$node_process.stdin.setRawMode(!0):null})}catch(c){return b=c,$APP.k($APP.k(MT)?$APP.Bb(a):MT)&&esm_import$node_process.stdin.setRawMode(!0),Promise.reject(b)}},LT=function(a,b){if($APP.k(function(){var e=$APP.n(JT);return $APP.k(e)?e:$APP.il($APP.n(KT))}()))return null;$APP.vg(JT,!0);var c=$APP.yp($APP.n(KT)),d=function(){try{var e=$APP.Uf([$APP.Oq,$APP.n(HT)]);$APP.Zp(e);try{return $APP.Xia(c)}finally{$APP.aq()}}catch(f){e=
f;if($APP.Ha($APP.hk(e),"EOF while reading"))return bYa;$Xa(c);$APP.zu.l($APP.z([$APP.l.g(e)]));return cYa}}();if($APP.x.h(cYa,d))return ZXa(b,a);if($APP.x.h(bYa,d))return $APP.vg(JT,!1);$Xa(c);if($APP.x.h($APP.tG,d))return $APP.vg(JT,!1);$APP.Zp($APP.Uf([$APP.Oq,$APP.n(HT)]));return aYa(a,function(){return $APP.pMa(d,new $APP.h(null,3,[$APP.P,$APP.n(HT),$APP.Wl,$APP.n($APP.wq),$APP.DI,$APP.Jw],null))}).then(function(e){var f=$APP.y.j(e,0,null);e=$APP.y.j(e,1,null);e=$APP.Wf(e);e=$APP.B.h(e,$APP.P);
$APP.vg(HT,e);$APP.gN.h($APP.QM,$APP.tg($APP.n($APP.PM)));$APP.gN.h($APP.PM,$APP.tg($APP.n($APP.OM)));$APP.gN.h($APP.OM,$APP.tg(f));$APP.k(a)&&a.write($APP.Sy.l($APP.z([f])));return ZXa(b,a)}).catch(function(e){$APP.zu.l($APP.z([$APP.l.g(e)]));$APP.gN.h($APP.RM,$APP.tg(e));return ZXa(b,a)}).finally(function(){return $APP.aq()})},dYa=function(a,b){a.on("line",function(c){$APP.Cj.F(KT,$APP.l,c,"\n");return LT(b,a)})},eYa=function(a){return esm_import$node_readline.createInterface({input:a,output:a,
completer:YXa})},fYa=function(a){var b=eYa(a);dYa(b,a);a.setNoDelay(!0);return a.on("close",function(){return $APP.Vy.l($APP.z(["Client closed connection."]))})},gYa=new $APP.q(null,"nbb.impl.repl","nbb.impl.repl",-339140484,null),bYa=new $APP.F("nbb.impl.repl","eof-while-reading","nbb.impl.repl/eof-while-reading",1743626215),hYa=new $APP.q("nbb.impl.repl","completer*","nbb.impl.repl/completer*",455172317,null),iYa=new $APP.q("nbb.impl.repl","repl","nbb.impl.repl/repl",-1645296655,null),jYa=new $APP.q(null,
"completer*","completer*",-648150376,null),kYa=new $APP.q("nbb.impl.repl","socket-repl","nbb.impl.repl/socket-repl",1509490200,null),lYa=new $APP.F(null,"init","init",-1875481434),mYa=new $APP.q(null,"get-completions","get-completions",1933789168,null),cYa=new $APP.F("nbb.impl.repl","continue","nbb.impl.repl/continue",-1326808644);var HT=$APP.Bj.g($APP.n($APP.Oq)),KT=$APP.Bj.g(""),JT=$APP.Bj.g(!1),MT,nYa=esm_import$node_process.stdout.isTTY;MT=$APP.k(nYa)?esm_import$node_process.stdin.setRawMode:nYa;var oYa=$APP.kN.h($APP.pz,null),NT=function NT(a){switch(arguments.length){case 0:return NT.D();case 1:return NT.g(arguments[0]);default:throw Error(["Invalid arity: ",$APP.l.g(arguments.length)].join(""));}};NT.D=function(){return NT.g(null)};
NT.g=function(a){var b=function(){var d=$APP.XF.g(a);return $APP.k(d)?d:0}(),c=esm_import$node_net.createServer(fYa);return c.listen(b,"127.0.0.1",function(){var d=c.address(),e=d.address;return $APP.Vy.l($APP.z([["Socket REPL listening on port ",$APP.l.g(d.port)," on host ",$APP.l.g(e)].join("")]))})};NT.B=1;var OT=function OT(a){switch(arguments.length){case 0:return OT.D();case 1:return OT.g(arguments[0]);default:throw Error(["Invalid arity: ",$APP.l.g(arguments.length)].join(""));}};OT.D=function(){return OT.g(null)};
OT.g=function(a){function b(e){return $APP.mMa(new $APP.D(null,$APP.Bk,new $APP.D(null,new $APP.D(null,$APP.Bk,new $APP.D(null,e,null,1,null),2,null),null,1,null),2,null))}$APP.k(MT)&&esm_import$node_process.stdin.setRawMode(!0);var c=$APP.y.j($APP.rN,0,null),d=$APP.y.j($APP.rN,1,null);$APP.Vy.l($APP.z([["Welcome to nbb-logseq v",$APP.kv(),"!"].join("")]));return b(c).then(function(){return b(d)}).then(lYa.h(a,$APP.ff)).then(function(){return new Promise(function(e){var f=$APP.k(null)?eYa(null):esm_import$node_readline.createInterface({input:esm_import$node_process.stdin,
output:esm_import$node_process.stdout,completer:YXa});dYa(f,null);f.setPrompt([$APP.l.g($APP.n(HT)),"\x3d\x3e "].join(""));f.on("close",e);return f.prompt()})})};OT.B=1;
var pYa=new $APP.h(null,3,[$APP.CMa,function(){var a=new $APP.Dd(function(){return OT},iYa,$APP.hi([$APP.P,$APP.N,$APP.Wl,$APP.Xz,$APP.rI,$APP.Pm,$APP.Xl,$APP.EK,$APP.U,$APP.M,$APP.kF],[gYa,$APP.CMa,"nbb/impl/repl.cljs",11,new $APP.h(null,6,[$APP.DA,!1,$APP.Rs,1,$APP.DJ,1,$APP.lJ,new $APP.G(null,2,5,$APP.H,[$APP.Tg,new $APP.G(null,1,5,$APP.H,[$APP.bG],null)],null),$APP.U,$APP.J($APP.Tg,new $APP.G(null,1,5,$APP.H,[$APP.bG],null)),$APP.fF,$APP.J(null,null)],null),1,187,187,$APP.J($APP.Tg,new $APP.G(null,
1,5,$APP.H,[$APP.bG],null)),null,$APP.k(OT)?OT.H:null])),b=$APP.n(a),c=$APP.te(a);a=$APP.k(null)?null:$APP.N.g(c);var d=new $APP.h(null,4,[$APP.P,oYa,$APP.N,a,$APP.U,$APP.U.g(c),$APP.M,$APP.M.g(c)],null);return $APP.k($APP.Vq.g(c))?$APP.eN.j(a,b,d):$APP.k(function(){var e=$APP.lq.g(c);return $APP.k(e)?e:$APP.yq.g(c)}())?$APP.fN.j(a,b,d):$APP.ju.j(a,b,d)}(),mYa,function(){var a=new $APP.Dd(function(){return IT},hYa,$APP.hi([$APP.P,$APP.N,$APP.Wl,$APP.Xz,$APP.Pm,$APP.Xl,$APP.EK,$APP.U,$APP.M,$APP.kF],
[gYa,jYa,"nbb/impl/repl.cljs",17,1,16,16,$APP.J(new $APP.G(null,1,5,$APP.H,[$APP.Rna],null)),"Given a line, returns a flat vector of completions",$APP.k(IT)?IT.H:null])),b=$APP.n(a),c=$APP.te(a);a=$APP.k(null)?null:$APP.N.g(c);var d=new $APP.h(null,4,[$APP.P,oYa,$APP.N,a,$APP.U,$APP.U.g(c),$APP.M,$APP.M.g(c)],null);return $APP.k($APP.Vq.g(c))?$APP.eN.j(a,b,d):$APP.k(function(){var e=$APP.lq.g(c);return $APP.k(e)?e:$APP.yq.g(c)}())?$APP.fN.j(a,b,d):$APP.ju.j(a,b,d)}(),$APP.BMa,function(){var a=new $APP.Dd(function(){return NT},
kYa,$APP.hi([$APP.P,$APP.N,$APP.Wl,$APP.Xz,$APP.rI,$APP.Pm,$APP.Xl,$APP.EK,$APP.U,$APP.M,$APP.kF],[gYa,$APP.BMa,"nbb/impl/repl.cljs",18,new $APP.h(null,6,[$APP.DA,!1,$APP.Rs,1,$APP.DJ,1,$APP.lJ,new $APP.G(null,2,5,$APP.H,[$APP.Tg,new $APP.G(null,1,5,$APP.H,[$APP.bG],null)],null),$APP.U,$APP.J($APP.Tg,new $APP.G(null,1,5,$APP.H,[$APP.bG],null)),$APP.fF,$APP.J(null,null)],null),1,172,172,$APP.J($APP.Tg,new $APP.G(null,1,5,$APP.H,[$APP.bG],null)),null,$APP.k(NT)?NT.H:null])),b=$APP.n(a),c=$APP.te(a);
a=$APP.k(null)?null:$APP.N.g(c);var d=new $APP.h(null,4,[$APP.P,oYa,$APP.N,a,$APP.U,$APP.U.g(c),$APP.M,$APP.M.g(c)],null);return $APP.k($APP.Vq.g(c))?$APP.eN.j(a,b,d):$APP.k(function(){var e=$APP.lq.g(c);return $APP.k(e)?e:$APP.yq.g(c)}())?$APP.fN.j(a,b,d):$APP.ju.j(a,b,d)}()],null);$APP.Zu(new $APP.h(null,1,[$APP.Lq,new $APP.h(null,1,[$APP.pz,pYa],null)],null));